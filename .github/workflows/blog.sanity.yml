name: Deploy Blog Sanity Studio

on:
  push:
    paths:
      - "apps/blog.sanity/**"
      - ".github/workflows/blog.sanity.yml"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.10.0

      - name: Checkout
        uses: actions/checkout@v3

      - name: Deploy to Sanity
        if: github.event_name == 'push'  && github.ref == 'refs/heads/main'
        run: |
          rm package.json
          npm i -g @sanity/cli
          pushd apps/blog.sanity
          npm install --legacy-peer-deps
          sanity deploy
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.BLOG_SANITY_DEPLOY_TOKEN }}